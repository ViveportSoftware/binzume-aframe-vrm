(()=>{var z=Object.create;var I=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var Z=i=>I(i,"__esModule",{value:!0});var S=i=>{if(typeof require!="undefined")return require(i);throw new Error('Dynamic require of "'+i+'" is not supported')};var X=(i,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of K(e))!Y.call(i,a)&&a!=="default"&&I(i,a,{get:()=>e[a],enumerable:!(t=G(e,a))||t.enumerable});return i},k=i=>X(Z(I(i!=null?z(J(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var B=class{constructor(e){this.target=null;this.angleLimit=60*Math.PI/180;this._identQ=new THREE.Quaternion;this._zV=new THREE.Vector3(0,0,-1);this._tmpQ0=new THREE.Quaternion;this._tmpV0=new THREE.Vector3;this._bone=e.nodes[e.vrm.firstPerson.firstPersonBone]}update(e){let t=this.target,a=this._bone;if(t==null||a==null)return;let o=a.worldToLocal(this._tmpV0.setFromMatrixPosition(t.matrixWorld)).normalize(),n=this._tmpQ0.setFromUnitVectors(this._zV,o),s=this.angleLimit,r=.08,h=2*Math.acos(n.w);h>s*1.5?(n=this._identQ,r=.04):h>s&&n.setFromAxisAngle(this._tmpV0.set(n.x,n.y,n.z).normalize(),s),a.quaternion.slerp(n,r)}};var O=class{constructor(e){this._currentShape={};this._avatar=e}setBlendShapeWeight(e,t){this._currentShape[e]=t,t==0&&delete this._currentShape[e],this._updateBlendShape()}getBlendShapeWeight(e){return this._currentShape[e]||0}resetBlendShape(){this._currentShape={},this._updateBlendShape()}startBlink(e){this.animatedMorph||(this.animatedMorph={name:"BLINK",times:[0,e-.2,e-.1,e],values:[0,0,1,0]},this._updateBlendShape())}startRaiseHandJoyAnimation(){this.animatedMorph&&this.stopBlink(),this.animatedMorph={name:"JOY",times:[0,.5,1,2,4,5,5.5],values:[0,.3,1,1,1,.4,.3]},this._updateBlendShape()}startStandingGreetingJoyAnimation(){this.animatedMorph&&this.stopBlink(),this.animatedMorph={name:"JOY",times:[0,1,2,2.5,3,5,6.3],values:[0,0,.3,.8,1,.4,.3]},this._updateBlendShape()}stopJoyAnimation(){this.animatedMorph=null,this._updateBlendShape()}startTalkingAnimation(){this.animatedMorph&&this.stopBlink();let e=Math.random()*.5,t=Math.random()*.5+.5,a=Math.min(Math.random()+.3,1),o=Math.random()*a;this.animatedMorph={name:"O",times:[0,e,.5,t,1],values:[0,o,a,.5,0]},this._updateBlendShape()}stopTalkingAnimation(){this.animatedMorph=null,this._updateBlendShape()}stopBlink(){this.animatedMorph=null,this._updateBlendShape()}_updateBlendShape(){let e=(s,r,h)=>{let d=this._avatar.blendShapes[r];d&&d.binds.forEach(l=>{let m=l.target.name,c=s[m]||(s[m]=new Array(l.target.morphTargetInfluences.length*h.length).fill(0));for(let u=0;u<h.length;u++){let g=u*l.target.morphTargetInfluences.length+l.index;c[g]+=Math.max(l.weight*h[u],c[g])}})},t=[0],a={};this.animatedMorph&&(t=this.animatedMorph.times,e(a,this.animatedMorph.name,this.animatedMorph.values));for(let[s,r]of Object.entries(this._currentShape))this._avatar.blendShapes[s]&&e(a,s,new Array(t.length).fill(r));let o=Object.entries(a).map(([s,r])=>new THREE.NumberKeyframeTrack(s+".morphTargetInfluences",t,r)),n=null;if(o.length>0){let s=new THREE.AnimationClip("morph",void 0,o);n=this._avatar.mixer.clipAction(s).setEffectiveWeight(1).play()}this.morphAction&&this.morphAction.stop(),this.morphAction=n}};var C=class{constructor(e){this._firstPersonBone=e.nodes[e.vrm.firstPerson.firstPersonBone],this._annotatedMeshes=e.vrm.firstPerson.meshAnnotations.map(t=>({flag:t.firstPersonFlag,mesh:e.meshes[t.mesh]}))}setFirstPerson(e){this._annotatedMeshes.forEach(t=>{t.flag=="ThirdPersonOnly"?t.mesh.visible=!e:t.flag=="FirstPersonOnly"?t.mesh.visible=e:t.flag=="Auto"&&this._firstPersonBone&&(e?this._genFirstPersonMesh(t.mesh):this._resetFirstPersonMesh(t.mesh))})}_genFirstPersonMesh(e){if(e.children.forEach(m=>this._genFirstPersonMesh(m)),!e.isSkinnedMesh)return;let t={};this._firstPersonBone.traverse(m=>{t[m.uuid]=!0});let a=e.skeleton.bones,o=e.geometry.attributes.skinIndex,n=e.geometry.attributes.skinWeight,s=e.geometry.index,r=[],h=0,d=0;for(let m=0;m<o.array.length;m++){let c=o.array[m];n.array[m]>0&&t[a[c].uuid]&&(r[m/o.itemSize|0]||(h++,r[m/o.itemSize|0]=!0))}let l=[];for(let m=0;m<s.count;m++)r[s.array[m]]&&!l[m/3|0]&&(l[m/3|0]=!0,d++);if(d!=0&&d*3==s.count){e.visible=!1;return}}_resetFirstPersonMesh(e){e.children.forEach(t=>this._resetFirstPersonMesh(t)),e.visible=!0}};var q=class{constructor(e){this.gltfLoader=e||new THREE.GLTFLoader(THREE.DefaultLoadingManager)}async load(e,t=[]){return new Promise((a,o)=>{this.gltfLoader.load(e,async n=>{a(await new Q(n).init(n,t))},void 0,o)})}},Q=class{constructor(e){this.bones={};this.blendShapes={};this.modules={};this.meta={};this.firstPersonBone=null;this._firstPersonMeshUtil=null;this.boneConstraints={head:{type:"ball",limit:60*Math.PI/180,twistAxis:new THREE.Vector3(0,1,0),twistLimit:60*Math.PI/180},neck:{type:"ball",limit:30*Math.PI/180,twistAxis:new THREE.Vector3(0,1,0),twistLimit:10*Math.PI/180},leftUpperLeg:{type:"ball",limit:170*Math.PI/180,twistAxis:new THREE.Vector3(0,-1,0),twistLimit:Math.PI/2},rightUpperLeg:{type:"ball",limit:170*Math.PI/180,twistAxis:new THREE.Vector3(0,-1,0),twistLimit:Math.PI/2},leftLowerLeg:{type:"hinge",axis:new THREE.Vector3(1,0,0),min:-170*Math.PI/180,max:0*Math.PI/180},rightLowerLeg:{type:"hinge",axis:new THREE.Vector3(1,0,0),min:-170*Math.PI/180,max:0*Math.PI/180}};this.model=e.scene,this.mixer=new THREE.AnimationMixer(this.model),this.isVRM=(e.userData.gltfExtensions||{}).VRM!=null,this.animations=e.animations||[],this._blendShapeUtil=new O(this)}async init(e,t){if(!this.isVRM)return this;let a=e.userData.gltfExtensions.VRM,o=this.bones,n=await e.parser.getDependencies("node"),s=await e.parser.getDependencies("mesh"),r={nodes:n,meshes:s,vrm:a,gltf:e};this.meta=a.meta,Object.values(a.humanoid.humanBones).forEach(h=>{o[h.bone]=n[h.node]}),a.firstPerson&&(a.firstPerson.firstPersonBone&&(this.firstPersonBone=n[a.firstPerson.firstPersonBone],this.modules.lookat=new B(r)),a.firstPerson.meshAnnotations&&(this._firstPersonMeshUtil=new C(r))),this.model.skeleton=new THREE.Skeleton(Object.values(o)),this._fixBoundingBox(),a.blendShapeMaster&&this._initBlendShapes(r);for(let h of t){let d=h.instantiate(this,r);d&&(this.modules[h.name]=d)}return this}_initBlendShapes(e){this.blendShapes=(e.vrm.blendShapeMaster.blendShapeGroups||[]).reduce((t,a)=>{let o=a.binds.flatMap(n=>{let s=e.meshes[n.mesh];return(s.isSkinnedMesh?[s]:s.children.filter(r=>r.isSkinnedMesh)).map(r=>({target:r,index:n.index,weight:n.weight/100}))});return t[(a.presetName||a.name).toUpperCase()]={name:a.name,binds:o},t},{})}_fixBoundingBox(){let e=this.bones;if(!e.hips)return;let t=new THREE.Vector3,a=e.hips.getWorldPosition(t).clone();this.model.traverse(o=>{let n=o;if(n.isSkinnedMesh){let s=n.getWorldPosition(t).sub(a).multiplyScalar(-1),r=s.clone().sub(n.geometry.boundingSphere.center).length()+n.geometry.boundingSphere.radius;n.geometry.boundingSphere.center.copy(s),n.geometry.boundingSphere.radius=r,n.geometry.boundingBox.min.set(s.x-r,s.y-r,s.z-r),n.geometry.boundingBox.max.set(s.x+r,s.y+r,s.z+r)}})}update(e){this.mixer.update(e);for(let t of Object.values(this.modules))t.update(e)}setModule(e,t){this.removeModule(e),this.modules[e]=t}removeModule(e){let t=this.modules[e];t&&t.dispose&&t.dispose(),delete this.modules[e]}dispose(){for(let e of Object.keys(this.modules))this.removeModule(e);this.model.traverse(e=>{let t=e;t.isMesh&&(t.geometry.dispose(),t.material.map?.dispose()),e.skeleton&&e.skeleton.dispose()})}get lookAtTarget(){let e=this.modules.lookat;return e?e.target:null}set lookAtTarget(e){let t=this.modules.lookat;t&&(t.target=e)}setBlendShapeWeight(e,t){this._blendShapeUtil.setBlendShapeWeight(e,t)}getBlendShapeWeight(e){return this._blendShapeUtil.getBlendShapeWeight(e)}resetBlendShape(){this._blendShapeUtil.resetBlendShape()}startBlink(e){this._blendShapeUtil.startBlink(e)}startRaiseHandJoyAnimation(){this._blendShapeUtil.startRaiseHandJoyAnimation()}startStandingGreetingJoyAnimation(){this._blendShapeUtil.startStandingGreetingJoyAnimation()}stopJoyAnimation(){this._blendShapeUtil.stopJoyAnimation()}startTalkingAnimation(){this._blendShapeUtil.startTalkingAnimation()}stopTalkingAnimation(){this._blendShapeUtil.stopTalkingAnimation()}stopBlink(){this._blendShapeUtil.stopBlink()}getPose(e){let t={bones:Object.keys(this.bones).map(a=>({name:a,q:this.bones[a].quaternion.toArray()}))};return e&&(t.blendShape=Object.keys(this.blendShapes).map(a=>({name:a,value:this.getBlendShapeWeight(a)}))),t}setPose(e){if(e.bones)for(let t of e.bones)this.bones[t.name]&&this.bones[t.name].quaternion.fromArray(t.q);if(e.blendShape)for(let t of e.blendShape)this.setBlendShapeWeight(t.name,t.value)}restPose(){for(let e of Object.values(this.bones))e.quaternion.set(0,0,0,1)}setFirstPerson(e){this._firstPersonMeshUtil&&this._firstPersonMeshUtil.setFirstPerson(e)}};var D=class{constructor(e){this.collisionGroup=2;this.enable=!1;this.binds=[];this.fixedBinds=[];this.bodies=[];this.constraints=[];this._tmpQ0=new THREE.Quaternion;this._tmpV0=new THREE.Vector3;this._tmpV1=new THREE.Vector3;this.world=null;this.internalWorld=!1;this.springBoneSystem=this._springBoneSystem(),this._init(e)}_init(e){if(!e.vrm.secondaryAnimation)return;let t=e.nodes,a=e.vrm.secondaryAnimation,o=0,n=.9;(a.colliderGroups||[]).forEach((s,r)=>{let h=t[s.node];for(let d of s.colliders){let l=new CANNON.Body({mass:0,collisionFilterGroup:1<<this.collisionGroup+r+1,collisionFilterMask:-1});l.addShape(new CANNON.Sphere(d.radius*n),d.offset),this.bodies.push(l),this.fixedBinds.push([h,l]),o|=l.collisionFilterGroup}});for(let s of a.boneGroups||[]){let r=new CANNON.Vec3().copy(s.gravityDir||{x:0,y:-1,z:0}).scale(s.gravityPower||0),h=s.hitRadius||.05,d=~(this.collisionGroup|o);for(let l of s.colliderGroups||[])d|=1<<this.collisionGroup+l+1;for(let l of s.bones){let m=new CANNON.Body({mass:0,collisionFilterGroup:0,collisionFilterMask:0});m.position.copy(t[l].parent.getWorldPosition(this._tmpV0)),this.bodies.push(m),this.fixedBinds.push([t[l].parent,m]);let c=(u,g)=>{let R=g.getWorldPosition(this._tmpV0),p=R.clone(),b=g.children.length+1;g.children.length>0?g.children.forEach(M=>{R.add(M.getWorldPosition(this._tmpV1))}):(R.add(g.parent.getWorldPosition(this._tmpV1).sub(R).normalize().multiplyScalar(-.1).add(R)),b=2),R.multiplyScalar(1/b);let E=new CANNON.Body({mass:.5,linearDamping:Math.max(s.dragForce||0,1e-4),angularDamping:Math.max(s.dragForce||0,1e-4),collisionFilterGroup:this.collisionGroup,collisionFilterMask:d,position:new CANNON.Vec3().copy(R)});E.addShape(new CANNON.Sphere(h)),this.bodies.push(E);let v=new CANNON.Vec3().copy(this._tmpV1.copy(p).sub(R)),x=new CANNON.Vec3().copy(p.sub(u.position)),f=new CANNON.PointToPointConstraint(E,v,u,x);this.constraints.push(f);let _=E.position.distanceTo(u.position);this.binds.push([g,E]),this.springBoneSystem.objects.push({body:E,parentBody:u,force:r,boneGroup:s,size:h,distanceToParent:_}),g.children.forEach(M=>M.isBone&&c(E,M))};c(m,t[l])}}}_springBoneSystem(){let e=new CANNON.Quaternion,t=new CANNON.Quaternion,a=new CANNON.Vec3;return{world:null,objects:[],update(){let o=this.world.gravity,n=this.world.dt,s=.1,r=1600;for(let h of this.objects){let d=h.body,l=h.parentBody,m=d.force,c=d.mass,u=h.force;m.x+=c*(-o.x+u.x),m.y+=c*(-o.y+u.y),m.z+=c*(-o.z+u.z);let g=d.position.distanceTo(l.position);Math.abs(g-h.distanceToParent)>.01&&g>0&&l.position.lerp(d.position,h.distanceToParent/g,d.position);let R=d.angularVelocity.length();R>s&&d.angularVelocity.scale(s/R,d.angularVelocity);let p=h.size*h.size*c,b=d.quaternion.mult(l.quaternion.inverse(e),t),[E,v]=b.toAxisAngle(a);v=v-Math.PI*2*Math.floor((v+Math.PI)/(Math.PI*2));let x=v*h.boneGroup.stiffiness*r;Math.abs(x)>Math.abs(v/n/n*.5)&&(x=v/n/n*.5);let f=E.scale(-x*p,E);d.torque.vadd(f,d.torque)}}}}attach(e){this.detach(),this.internalWorld=e==null,this.world=e||new CANNON.World,this.springBoneSystem.world=this.world,this.world.subsystems.push(this.springBoneSystem),this.bodies.forEach(t=>this.world.addBody(t)),this.constraints.forEach(t=>this.world.addConstraint(t)),this.reset(),this.enable=!0,this.world.bodies.forEach(t=>{t.collisionFilterGroup==1&&t.collisionFilterMask==1&&(t.collisionFilterMask=-1)})}detach(){!this.world||(this.world.subsystems=this.world.subsystems.filter(e=>e!=this.springBoneSystem),this.world.constraints=this.world.constraints.filter(e=>!this.constraints.includes(e)),this.world.bodies=this.world.bodies.filter(e=>!this.bodies.includes(e)),this.world=null,this.enable=!1)}reset(){this.fixedBinds.forEach(([e,t])=>{e.updateWorldMatrix(!0,!1),t.position.copy(e.getWorldPosition(this._tmpV0)),t.quaternion.copy(e.parent.getWorldQuaternion(this._tmpQ0))}),this.binds.forEach(([e,t])=>{e.updateWorldMatrix(!0,!1),t.position.copy(e.getWorldPosition(this._tmpV0)),t.quaternion.copy(e.getWorldQuaternion(this._tmpQ0))})}update(e){!this.enable||(this.fixedBinds.forEach(([t,a])=>{a.position.copy(t.getWorldPosition(this._tmpV0)),a.quaternion.copy(t.getWorldQuaternion(this._tmpQ0))}),this.internalWorld&&this.world.step(1/60,e),this.binds.forEach(([t,a])=>{t.quaternion.copy(a.quaternion).premultiply(t.parent.getWorldQuaternion(this._tmpQ0).invert())}))}dispose(){this.detach()}};var F=class{constructor(e,t,a){this.quaternion=new THREE.Quaternion;this.worldMatrix=new THREE.Matrix4;this.worldPosition=new THREE.Vector3;this.position=e,this.constraint=t,this.userData=a}},U=class{constructor(){this.iterationLimit=50;this.thresholdSq=1e-4;this._iv=new THREE.Vector3(1,1,1);this._tmpV0=new THREE.Vector3;this._tmpV1=new THREE.Vector3;this._tmpV2=new THREE.Vector3;this._tmpQ0=new THREE.Quaternion;this._tmpQ1=new THREE.Quaternion}_updateChain(e,t){for(let a of e)a.worldMatrix.compose(a.position,a.quaternion,this._iv).premultiply(t),a.worldPosition.setFromMatrixPosition(a.worldMatrix),t=a.worldMatrix}solve(e,t,a){this._updateChain(e,a);let o=e[e.length-1].worldPosition,n=o.distanceToSquared(t),s=this._tmpV2,r=this._tmpV1,h=this._tmpQ1;for(let d=0;d<this.iterationLimit&&!(o.distanceToSquared(t)<this.thresholdSq);d++){let l=this._tmpV0.copy(t);for(let m=e.length-2;m>=0;m--){let c=e[m],u=e[m+1].position;c.worldMatrix.decompose(this._tmpV1,this._tmpQ0,this._tmpV2),s.copy(l).sub(this._tmpV1).applyQuaternion(h.copy(this._tmpQ0).invert()).normalize(),r.copy(u).normalize(),h.setFromUnitVectors(r,s),c.quaternion.multiply(h);let g=r.copy(u).applyQuaternion(this._tmpQ0.multiply(h));c.constraint&&(h.copy(c.quaternion).invert(),c.constraint.apply(c)&&(h.premultiply(c.quaternion),g.copy(u).applyQuaternion(this._tmpQ0.multiply(h)))),l.sub(g)}this._updateChain(e,a)}return o.distanceToSquared(t)<n}};var W=class{constructor(){this.boneMapping=[{bone:"hips",nodeNames:["\u30BB\u30F3\u30BF\u30FC","center"]},{bone:"spine",nodeNames:["\u4E0A\u534A\u8EAB","upper body"]},{bone:"chest",nodeNames:["\u4E0A\u534A\u8EAB2","upper body2"]},{bone:"neck",nodeNames:["\u9996","neck"]},{bone:"head",nodeNames:["\u982D","head"]},{bone:"leftShoulder",nodeNames:["\u5DE6\u80A9","shoulder_L"]},{bone:"leftUpperArm",nodeNames:["\u5DE6\u8155","arm_L"]},{bone:"leftLowerArm",nodeNames:["\u5DE6\u3072\u3058","elbow_L"]},{bone:"leftHand",nodeNames:["\u5DE6\u624B\u9996","wrist_L"]},{bone:"rightShoulder",nodeNames:["\u53F3\u80A9","shoulder_R"]},{bone:"rightUpperArm",nodeNames:["\u53F3\u8155","arm_R"]},{bone:"rightLowerArm",nodeNames:["\u53F3\u3072\u3058","elbow_R"]},{bone:"rightHand",nodeNames:["\u53F3\u624B\u9996","wrist_R"]},{bone:"leftUpperLeg",nodeNames:["\u5DE6\u8DB3","leg_L"]},{bone:"leftLowerLeg",nodeNames:["\u5DE6\u3072\u3056","knee_L"]},{bone:"leftFoot",nodeNames:["\u5DE6\u8DB3\u9996","ankle_L"]},{bone:"leftToes",nodeNames:["\u5DE6\u3064\u307E\u5148","L toe"]},{bone:"rightUpperLeg",nodeNames:["\u53F3\u8DB3","leg_R"]},{bone:"rightLowerLeg",nodeNames:["\u53F3\u3072\u3056","knee_R"]},{bone:"rightFoot",nodeNames:["\u53F3\u8DB3\u9996","ankle_R"]},{bone:"rightToes",nodeNames:["\u53F3\u3064\u307E\u5148","R toe"]},{bone:"leftEye",nodeNames:["\u5DE6\u76EE","eye_L"]},{bone:"rightEye",nodeNames:["\u53F3\u76EE","eye_R"]},{bone:"leftThumbProximal",nodeNames:["\u5DE6\u89AA\u6307\uFF10","thumb0_L"]},{bone:"leftThumbIntermediate",nodeNames:["\u5DE6\u89AA\u6307\uFF11","thumb1_L"]},{bone:"leftThumbDistal",nodeNames:["\u5DE6\u89AA\u6307\uFF12","thumb2_L"]},{bone:"leftIndexProximal",nodeNames:["\u5DE6\u4EBA\u6307\uFF11","fore1_L"]},{bone:"leftIndexIntermediate",nodeNames:["\u5DE6\u4EBA\u6307\uFF12","fore2_L"]},{bone:"leftIndexDistal",nodeNames:["\u5DE6\u4EBA\u6307\uFF13","fore3_L"]},{bone:"leftMiddleProximal",nodeNames:["\u5DE6\u4E2D\u6307\uFF11","middle1_L"]},{bone:"leftMiddleIntermediate",nodeNames:["\u5DE6\u4E2D\u6307\uFF12","middle2_L"]},{bone:"leftMiddleDistal",nodeNames:["\u5DE6\u4E2D\u6307\uFF13","middle3_L"]},{bone:"leftRingProximal",nodeNames:["\u5DE6\u85AC\u6307\uFF11","third1_L"]},{bone:"leftRingIntermediate",nodeNames:["\u5DE6\u85AC\u6307\uFF12","third2_L"]},{bone:"leftRingDistal",nodeNames:["\u5DE6\u85AC\u6307\uFF13","third3_L"]},{bone:"leftLittleProximal",nodeNames:["\u5DE6\u5C0F\u6307\uFF11","little1_L"]},{bone:"leftLittleIntermediate",nodeNames:["\u5DE6\u5C0F\u6307\uFF12","little2_L"]},{bone:"leftLittleDistal",nodeNames:["\u5DE6\u5C0F\u6307\uFF13","little3_L"]},{bone:"rightThumbProximal",nodeNames:["\u53F3\u89AA\u6307\uFF10","thumb0_R"]},{bone:"rightThumbIntermediate",nodeNames:["\u53F3\u89AA\u6307\uFF11","thumb1_R"]},{bone:"rightThumbDistal",nodeNames:["\u53F3\u89AA\u6307\uFF12","thumb2_R"]},{bone:"rightIndexProximal",nodeNames:["\u53F3\u4EBA\u6307\uFF11","fore1_R"]},{bone:"rightIndexIntermediate",nodeNames:["\u53F3\u4EBA\u6307\uFF12","fore2_R"]},{bone:"rightIndexDistal",nodeNames:["\u53F3\u4EBA\u6307\uFF13","fore3_R"]},{bone:"rightMiddleProximal",nodeNames:["\u53F3\u4E2D\u6307\uFF11","middle1_R"]},{bone:"rightMiddleIntermediate",nodeNames:["\u53F3\u4E2D\u6307\uFF12","middle2_R"]},{bone:"rightMiddleDistal",nodeNames:["\u53F3\u4E2D\u6307\uFF13","middle3_R"]},{bone:"rightRingProximal",nodeNames:["\u53F3\u85AC\u6307\uFF11","third1_R"]},{bone:"rightRingIntermediate",nodeNames:["\u53F3\u85AC\u6307\uFF12","third2_R"]},{bone:"rightRingDistal",nodeNames:["\u53F3\u85AC\u6307\uFF13","third3_R"]},{bone:"rightLittleProximal",nodeNames:["\u53F3\u5C0F\u6307\uFF11","little1_R"]},{bone:"rightLittleIntermediate",nodeNames:["\u53F3\u5C0F\u6307\uFF12","little2_R"]},{bone:"rightLittleDistal",nodeNames:["\u53F3\u5C0F\u6307\uFF13","little3_R"]}];this.blendShapeMap={A:"\u3042",I:"\u3044",U:"\u3046",E:"\u3048",O:"\u304A",BLINK:"\u307E\u3070\u305F\u304D"};this.rotationOffsets={leftUpperArm:-38*THREE.MathUtils.DEG2RAD,rightUpperArm:38*THREE.MathUtils.DEG2RAD};this.ikConfigs=[{target:"\u5DE6\u8DB3\uFF29\uFF2B",bones:["leftFoot","leftLowerLeg","leftUpperLeg"]},{target:"\u53F3\u8DB3\uFF29\uFF2B",bones:["rightFoot","rightLowerLeg","rightUpperLeg"]},{target:"\u5DE6\u3064\u307E\u5148\uFF29\uFF2B",parent:0,bones:["leftToes","leftFoot"]},{target:"\u53F3\u3064\u307E\u5148\uFF29\uFF2B",parent:1,bones:["rightToes","rightFoot"]}];this.boneConstraints={leftLowerLeg:{min:new THREE.Vector3(-175*Math.PI/180,0,0),max:new THREE.Vector3(0,0,0)},rightLowerLeg:{min:new THREE.Vector3(-175*Math.PI/180,0,0),max:new THREE.Vector3(0,0,0)},leftUpperLeg:{min:new THREE.Vector3(-Math.PI/2,-Math.PI/2,-Math.PI/2),max:new THREE.Vector3(Math.PI,Math.PI/2,Math.PI/2)},rightUpperLeg:{min:new THREE.Vector3(-Math.PI/2,-Math.PI/2,-Math.PI/2),max:new THREE.Vector3(Math.PI,Math.PI/2,Math.PI/2)}}}async load(e,t,a){let{MMDLoader:o}=await import("https://threejs.org/examples/jsm/loaders/MMDLoader.js"),{CCDIKSolver:n}=await import("https://threejs.org/examples/jsm/animation/CCDIKSolver.js"),s=new o,r={};for(let p of this.boneMapping){let b=t.bones[p.bone];if(b)for(let E of p.nodeNames)r[E]=b.name}let h={},d={};for(let[p,b]of Object.entries(this.rotationOffsets)){let E=t.bones[p];E&&(h[E.name]=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),b),E.traverse(v=>{d[v.name]=[Math.cos(b),Math.sin(b)]}))}let l={};for(let[p,b]of Object.entries(this.blendShapeMap))t.blendShapes[p]&&(l[b]=p);t.model.morphTargetDictionary=l;let m=.08,c=(p,b)=>{[p[0],p[2]]=[p[0]*b[0]-p[2]*b[1],p[0]*b[1]+p[2]*b[0]]},u=(p,b)=>{[p[0],p[1]]=[p[0]*b[0]-p[1]*b[1],p[0]*b[1]+p[1]*b[0]]},g=new THREE.Quaternion,R=new THREE.Quaternion;return await new Promise((p,b)=>{s.loadVMD(e,async E=>{let v=E.motions.filter(f=>f.boneName=="\u4E0B\u534A\u8EAB");if(v.length){v.sort((_,M)=>_.frameNum-M.frameNum);let f=(_,M)=>{_.sort((T,w)=>T.frameNum-w.frameNum);let y=0;for(let T of _){for(;y<v.length-1&&T.frameNum>v[y].frameNum;)y++;let w=R.fromArray(v[y].rotation);if(y>0&&T.frameNum<v[y].frameNum){let A=(T.frameNum-v[y-1].frameNum)/(v[y].frameNum-v[y-1].frameNum);w.slerp(g.fromArray(v[y-1].rotation),1-A)}M&&w.invert(),T.rotation=g.fromArray(T.rotation).multiply(w).toArray()}};f(E.motions.filter(_=>_.boneName=="\u30BB\u30F3\u30BF\u30FC"),!1),f(E.motions.filter(_=>_.boneName=="\u4E0A\u534A\u8EAB"),!0),v.forEach(_=>_.rotation=[0,0,0,1])}for(let f of E.motions){r[f.boneName]&&(f.boneName=r[f.boneName]);let _=h[f.boneName];_&&(f.rotation=g.fromArray(f.rotation).premultiply(_).toArray()),f.position[0]*=m,f.position[1]*=m,f.position[2]*=m,c(f.position,[-1,0]),c(f.rotation,[-1,0]);let M=d[f.boneName];M&&(u(f.position,M),u(f.rotation,M))}if(a.enableIK){let f=t.model.skeleton.bones,_=y=>{let T=f.findIndex(L=>L.name==y.target);if(T>=0)return T;let w=y.parent!=null?f[_(this.ikConfigs[y.parent])]:t.model,A=new THREE.Bone;A.name=y.target,f.push(A),w.add(A),w.updateMatrixWorld();let P=t.bones[y.bones[0]].getWorldPosition(new THREE.Vector3);return A.position.copy(P.applyMatrix4(w.matrixWorld.clone().invert())),f.length-1},M=[];for(let y of this.ikConfigs){if(E.motions.find(L=>L.boneName==y.target)==null)continue;let T=L=>f.findIndex(N=>N==t.bones[L]),w=T(y.bones[0]);if(w<0)continue;let A=[];y.bones.slice(1).forEach(L=>{let N=T(L);if(N>=0){let H={index:N},V=this.boneConstraints[L];V&&(H.rotationMax=V.max,H.rotationMin=V.min),A.push(H)}});let P={target:_(y),effector:w,links:A,maxAngle:1,iteration:4};M.push(P)}if(M.length>0){console.log(M);let y=new n(t.model,M);t.setModule("MMDIK",{update:T=>y.update()})}}let x=s.animationBuilder.build(E,t.model);x.tracks.forEach(f=>{let _=f.name.match(/.morphTargetInfluences\[(\w+)\]/);if(_){let M=t.blendShapes[_[1]];M&&M.binds.length>0&&(f.name=M.binds[0].target.uuid+".morphTargetInfluences["+M.binds[0].index+"]")}}),p(x)},()=>{},b)})}};var j=class{constructor(){this.existsPreviousThumbName=!1;this.legacyBoneMapping={leftThumbMetacarpal:"leftThumbProximal",leftThumbProximal:"leftThumbIntermediate",rightThumbMetacarpal:"rightThumbProximal",rightThumbProximal:"rightThumbIntermediate"}}async load(e,t,a){this.existsPreviousThumbName=t.bones.leftThumbIntermediate!=null||t.bones.rightThumbIntermediate!=null;let{BVHLoader:o}=await import("https://threejs.org/examples/jsm/loaders/BVHLoader.js");return await new Promise((n,s)=>{let r=e;if(window.VRM_ANIMATIONS=window.VRM_ANIMATIONS||{},!window.VRM_ANIMATIONS[r])new o().load(e,h=>{window.VRM_ANIMATIONS[r]={clip:h.clip.clone(),bones:h.skeleton.bones},n(this.fixTracks(h.clip,t,h.skeleton.bones,a))});else{let{clip:h,bones:d}=window.VRM_ANIMATIONS[r];n(this.fixTracks(h.clone(),t,d,a))}})}fixTracks(e,t,a,o){return o.convertBone&&this.fixTrackName(e,t,a),e.tracks=this.isLegacyMotionSkeleton(a)?e.tracks.filter(n=>!n.name.match(/position/)):e.tracks.filter(n=>!n.name.match(/position/)||n.name.match(t.bones.hips.name)),e}convertBoneName(e){if(e=e.replace("Spin1","Spin"),e=e.replace("Chest1","Chest"),e=e.replace("Chest2","UpperChest"),e=e.replace("UpLeg","UpperLeg"),e=e.replace("LeftLeg","LeftLowerLeg"),e=e.replace("RightLeg","RightLowerLeg"),e=e.replace("ForeArm","UpperArm"),e=e.replace("LeftArm","LeftLowerArm"),e=e.replace("RightArm","RightLowerArm"),e=e.replace("Collar","Shoulder"),e=e.replace("Elbow","LowerArm"),e=e.replace("Wrist","Hand"),e=e.replace("LeftHip","LeftUpperLeg"),e=e.replace("RightHip","RightUpperLeg"),e=e.replace("Knee","LowerLeg"),e=e.replace("Ankle","Foot"),this.existsPreviousThumbName){let t=this.legacyBoneMapping[e];t&&(e=e.replace(e,t))}return e.charAt(0).toLowerCase()+e.slice(1)}isLegacyMotionSkeleton(e){return e.filter(t=>t.name=="hips"||t.name=="upperChest").length!=2}fixTrackName(e,t,a){let o=new THREE.Vector3,n=(a.find(l=>l.name=="hips")?.position.y||0)*2.005,s=t.bones.hips?.getWorldPosition(o).y,r=t.model.getWorldPosition(o).y,h=Math.abs(s-r),d=this.isLegacyMotionSkeleton(a)?.09:h/n;e.tracks.forEach(l=>{l.name=l.name.replace(/bones\[(\w+)\]/,(m,c)=>{let u=t.bones[this.convertBoneName(c)];return"bones["+(u!=null?u.name:"NODE_NOT_FOUND")+"]"}),l.name=l.name.replace("ToeBase","Foot"),l.name.match(/quaternion/)&&(l.values=l.values.map((m,c)=>c%2==0?-m:m)),l.name.match(/position/)&&(l.values=l.values.map((m,c)=>(c%3==1?m:-m)*d))}),e.tracks=e.tracks.filter(l=>!l.name.match(/NODE_NOT_FOUND/))}};var $={bones:[{name:"hips",q:[0,0,0,1]},{name:"leftUpperLeg",q:[0,0,0,1]},{name:"rightUpperLeg",q:[0,0,0,1]},{name:"leftLowerLeg",q:[0,0,0,1]},{name:"rightLowerLeg",q:[0,0,0,1]},{name:"leftFoot",q:[0,0,0,1]},{name:"rightFoot",q:[0,0,0,1]},{name:"spine",q:[0,0,0,1]},{name:"chest",q:[0,0,0,1]},{name:"neck",q:[0,0,0,1]},{name:"head",q:[.06085100730464933,-.02202995606372791,0,.9979037207796351]},{name:"leftShoulder",q:[0,0,0,1]},{name:"rightShoulder",q:[0,0,0,1]},{name:"leftUpperArm",q:[-.0039010895844694173,-.1543204839727681,.539642514262409,.8276206416752847]},{name:"rightUpperArm",q:[.009326220145646762,.1736606185406724,-.5211727795846239,.8355441011735436]},{name:"leftLowerArm",q:[.056406304529277126,-.017647952075557537,.005438403159162174,.9982370972709678]},{name:"rightLowerArm",q:[.054974313124661875,.02083301559003829,.0050595917092329966,.9982575874440588]},{name:"leftHand",q:[0,0,0,1]},{name:"rightHand",q:[0,0,0,1]},{name:"leftToes",q:[0,0,0,1]},{name:"rightToes",q:[0,0,0,1]},{name:"leftEye",q:[0,0,0,1]},{name:"rightEye",q:[0,0,0,1]},{name:"jaw",q:[0,0,0,1]},{name:"leftThumbProximal",q:[0,0,0,1]},{name:"leftThumbIntermediate",q:[0,0,0,1]},{name:"leftThumbDistal",q:[0,0,0,1]},{name:"leftIndexProximal",q:[0,0,0,1]},{name:"leftIndexIntermediate",q:[0,0,0,1]},{name:"leftIndexDistal",q:[0,0,0,1]},{name:"leftMiddleProximal",q:[0,0,0,1]},{name:"leftMiddleIntermediate",q:[0,0,0,1]},{name:"leftMiddleDistal",q:[0,0,0,1]},{name:"leftRingProximal",q:[0,0,0,1]},{name:"leftRingIntermediate",q:[0,0,0,1]},{name:"leftRingDistal",q:[0,0,0,1]},{name:"leftLittleProximal",q:[0,0,0,1]},{name:"leftLittleIntermediate",q:[0,0,0,1]},{name:"leftLittleDistal",q:[0,0,0,1]},{name:"rightThumbProximal",q:[0,0,0,1]},{name:"rightThumbIntermediate",q:[0,0,0,1]},{name:"rightThumbDistal",q:[0,0,0,1]},{name:"rightIndexProximal",q:[0,0,0,1]},{name:"rightIndexIntermediate",q:[0,0,0,1]},{name:"rightIndexDistal",q:[0,0,0,1]},{name:"rightMiddleProximal",q:[0,0,0,1]},{name:"rightMiddleIntermediate",q:[0,0,0,1]},{name:"rightMiddleDistal",q:[0,0,0,1]},{name:"rightRingProximal",q:[0,0,0,1]},{name:"rightRingIntermediate",q:[0,0,0,1]},{name:"rightRingDistal",q:[0,0,0,1]},{name:"rightLittleProximal",q:[0,0,0,1]},{name:"rightLittleIntermediate",q:[0,0,0,1]},{name:"rightLittleDistal",q:[0,0,0,1]},{name:"upperChest",q:[0,0,0,1]}],blendShape:[{name:"NEUTRAL",value:0},{name:"A",value:0},{name:"I",value:0},{name:"U",value:0},{name:"E",value:0},{name:"O",value:0},{name:"BLINK",value:0},{name:"JOY",value:0},{name:"ANGRY",value:0},{name:"SORROW",value:0},{name:"FUN",value:0},{name:"LOOKUP",value:0},{name:"LOOKDOWN",value:0},{name:"LOOKLEFT",value:0},{name:"LOOKRIGHT",value:0},{name:"BLINK_L",value:0},{name:"BLINK_R",value:0}]};AFRAME.registerComponent("vrm",{schema:{src:{default:""},firstPerson:{default:!1},blink:{default:!0},blinkInterval:{default:5},lookAt:{type:"selector"},enablePhysics:{default:!1}},init(){this.avatar=null},update(i){this.data.src!==i.src&&(this.remove(),this._loadAvatar()),this._updateAvatar()},tick(i,e){if(!this.avatar){this.pause();return}this.avatar.update(e/1e3)},remove(){this.avatar&&(this.el.removeObject3D("avatar"),this.avatar.dispose())},async _loadAvatar(){let i=this.el,e=this.data.src;if(!!e)try{let t=[];globalThis.CANNON&&t.push({name:"physics",instantiate:(o,n)=>new D(n)});let a=await new q().load(e,t);if(e!=this.data.src){a.dispose();return}this.avatar=a,i.setObject3D("avatar",a.model),this._updateAvatar(),this.play(),i.emit("model-loaded",{format:"vrm",model:a.model,avatar:a},!1)}catch(t){console.error("vrm model-error",t),i.emit("model-error",{format:"vrm",src:e,cause:t},!1)}},_updateAvatar(){if(!this.avatar)return;let i=this.data;this.avatar.setFirstPerson(i.firstPerson),i.lookAt?i.lookAt.tagName=="A-CAMERA"?this.avatar.lookAtTarget=this.el.sceneEl.camera:this.avatar.lookAtTarget=i.lookAt.object3D:this.avatar.lookAtTarget=null,i.blink?this.avatar.startBlink(i.blinkInterval):this.avatar.stopBlink();let e=this.avatar.modules.physics;if(e){if(i.enablePhysics&&e.world==null){let t=this.el.sceneEl.systems.physics;e.attach(t&&t.driver&&t.driver.world)}e.enable=i.enablePhysics}}});AFRAME.registerComponent("vrm-anim",{schema:{src:{default:""},format:{default:""},loop:{default:!0},enableIK:{default:!0},convertBone:{default:!0},defaultMotion:{default:""}},init(){this.avatar=null,this.el.components.vrm&&this.el.components.vrm.avatar&&(this.avatar=this.el.components.vrm.avatar),this.onVrmLoaded=i=>{this.avatar=i.detail.avatar,this.data.src!=""?this._loadClip(this.data.src):this.avatar.animations.length>0?this.playClip(this.avatar.animations[0]):this.playTestMotion()},this.el.addEventListener("model-loaded",this.onVrmLoaded)},update(i){i.src!=this.data.src&&this.avatar&&this._loadClip(this.data.src)},async _loadClip(i){if(this.stopAnimation(),this.avatar.setPose($),i==="")return;let e=this.data.loop?THREE.LoopRepeat:THREE.LoopOnce,o=await((this.data.format||(i.toLowerCase().endsWith(".bvh")?"bvh":""))=="bvh"?new j:new W).load(i,this.avatar,this.data);!this.avatar||this.playClip(o)},stopAnimation(){this.animation&&(this.animation.stop(),this.avatar.removeModule("MMDIK"),this.animation=null)},playTestMotion(){if(this.data.defaultMotion){this._loadClip(this.data.defaultMotion);return}let i=(a,o,n)=>new THREE.Quaternion().setFromEuler(new THREE.Euler(a*Math.PI/180,o*Math.PI/180,n*Math.PI/180)),e={leftUpperArm:{keys:[{rot:i(0,0,65),time:0},{rot:i(0,0,63),time:1},{rot:i(0,0,65),time:2}]},rightUpperArm:{keys:[{rot:i(0,0,-65),time:0},{rot:i(0,0,-60),time:1},{rot:i(0,0,-65),time:2}]},spine:{keys:[{rot:i(0,2,0),time:0},{rot:i(2,0,-2),time:1},{rot:i(2,-2,0),time:2},{rot:i(0,0,2),time:3},{rot:i(0,2,0),time:4}]}},t=THREE.AnimationClip.parseAnimation({name:"testAnimation",hierarchy:Object.values(e)},Object.keys(e).map(a=>this.avatar.bones[a]||{name:a}));this.playClip(t)},playClip(i){let e=this.data.loop?THREE.LoopRepeat:THREE.LoopOnce;this.stopAnimation(),this.clip=i,this.animation=this.avatar.mixer.clipAction(i).setLoop(e).setEffectiveWeight(1).play(),this.animation.clampWhenFinished=!0},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this.stopAnimation(),this.avatar=null}});AFRAME.registerComponent("vrm-skeleton",{schema:{physicsOffset:{type:"vec3",default:{x:0,y:0,z:0}}},init(){this.physicsBodies=[],this.sceneObj=this.el.sceneEl.object3D,this.el.components.vrm&&this.el.components.vrm.avatar&&this._onAvatarUpdated(this.el.components.vrm.avatar),this.onVrmLoaded=i=>this._onAvatarUpdated(i.detail.avatar),this.el.addEventListener("model-loaded",this.onVrmLoaded)},_onAvatarUpdated(i){this.helper&&this.sceneObj.remove(this.helper),this.helper=new THREE.SkeletonHelper(i.model),this.sceneObj.add(this.helper),this._updatePhysicsBody(i)},_updatePhysicsBody(i){this._clearPhysicsBody();let e=i.modules.physics;if(!e||!e.world)return;let t=new THREE.SphereGeometry(1,6,3),a=new THREE.MeshBasicMaterial({color:new THREE.Color("red"),wireframe:!0,depthTest:!1});e.bodies.forEach(o=>{let n=new THREE.Group;o.shapes.forEach((s,r)=>{let h=new THREE.Mesh(t,a);h.position.copy(o.shapeOffsets[r]),h.scale.multiplyScalar(s.boundingSphereRadius||.01),n.add(h)}),this.sceneObj.add(n),this.physicsBodies.push([o,n])})},_clearPhysicsBody(){this.physicsBodies.forEach(([i,e])=>e.parent.remove(e)),this.physicsBodies=[]},tick(){this.physicsBodies.forEach(([i,e])=>{e.position.copy(i.position).add(this.data.physicsOffset),e.quaternion.copy(i.quaternion)})},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this._clearPhysicsBody(),this.helper&&this.sceneObj.remove(this.helper)}});AFRAME.registerComponent("vrm-poser",{schema:{color:{default:"#00ff00"},enableConstraints:{default:!0}},init(){this.binds=[],this._tmpV0=new THREE.Vector3,this._tmpV1=new THREE.Vector3,this._tmpQ0=new THREE.Quaternion,this._tmpQ1=new THREE.Quaternion,this._tmpM0=new THREE.Matrix4,this.el.components.vrm&&this.el.components.vrm.avatar&&this._onAvatarUpdated(this.el.components.vrm.avatar),this.onVrmLoaded=i=>this._onAvatarUpdated(i.detail.avatar),this.el.addEventListener("model-loaded",this.onVrmLoaded)},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded),this._removeHandles()},getPoseData(i){if(!!this.avatar)return this.avatar.getPose(i)},setPoseData(i){!this.avatar||(this.avatar.setPose(i),this._updateHandlePosition())},_onAvatarUpdated(i){this._removeHandles(),this.avatar=i;let e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial({color:new THREE.Color(this.data.color),transparent:!0,opacity:.4,depthTest:!1}),a=this._tmpV0,o=this._tmpV1,n=this._tmpM0,s=this._tmpQ0,r=i.bones.hips,h={};for(let d of Object.keys(i.bones)){let l=i.bones[d],m=l==r,c=new THREE.Mesh(e,t),u=document.createElement("a-entity");u.classList.add("collidable"),u.setAttribute("xy-drag-control",{}),u.setObject3D("handle",c);let g=u.object3D,R=l.children.reduce((b,E)=>Math.min(b,E.position.length()),l.position.length());g.scale.multiplyScalar(Math.max(Math.min(R/2,.05),.01)),h[l.uuid]=d,u.addEventListener("mousedown",b=>{this.el.emit("vrm-poser-select",{name:d,node:l})});let p=l.parent;for(;!h[p.uuid]&&p.parent&&p.parent.isBone;)p=p.parent;u.addEventListener("xy-drag",b=>{if(m){let E=g.parent.worldToLocal(l.getWorldPosition(a)).sub(g.position);i.model.position.sub(E)}p.updateMatrixWorld(!1),g.updateMatrixWorld(!1),n.getInverse(p.matrixWorld).multiply(g.matrixWorld).decompose(o,s,a),l.quaternion.copy(this._applyConstraintQ(d,s)),s.setFromUnitVectors(a.copy(l.position).normalize(),o.normalize()),p.children.length==1&&(p.quaternion.multiply(s),this._applyConstraintQ(h[p.uuid],p.quaternion)),this._updateHandlePosition(m?null:l)}),u.addEventListener("xy-dragend",b=>{this._updateHandlePosition(),console.log(p.name,d)}),this.el.appendChild(u),this.binds.push([l,g])}this._updateHandlePosition()},_applyConstraintQ(i,e){if(!this.data.enableConstraints)return e;let t=this._tmpQ1,a=this._tmpV0,o=this.avatar.boneConstraints[i];if(o&&o.type=="ball"){let n=2*Math.acos(e.w);if(o.twistAxis){let s=n*Math.acos(e.w)*a.copy(e).normalize().dot(o.twistAxis);if(s=this._normalizeAngle(s),Math.abs(s)>o.twistLimit){let r=s<0?s+o.twistLimit:s-o.twistLimit;e.multiply(t.setFromAxisAngle(o.twistAxis,-r)),n=2*Math.acos(e.w)}}Math.abs(this._normalizeAngle(n))>o.limit&&e.setFromAxisAngle(a.copy(e).normalize(),o.limit)}else if(o&&o.type=="hinge"){let n=(o.min+o.max)/2,s=2*Math.acos(e.w)*a.copy(e).normalize().dot(o.axis);s=THREE.MathUtils.clamp(this._normalizeAngle(s-n),o.min-n,o.max-n),e.setFromAxisAngle(o.axis,s+n)}return e},_normalizeAngle(i){return i-Math.PI*2*Math.floor((i+Math.PI)/(Math.PI*2))},_removeHandles(){this.binds.forEach(([i,e])=>{this.el.removeChild(e.el);let t=e.el.getObject3D("handle");t&&(t.material.dispose(),t.geometry.dispose()),e.el.destroy()}),this.binds=[]},_updateHandlePosition(i){let e=this._tmpV0,t=this.el.object3D;t.updateMatrixWorld(!1);let a=t.matrixWorld.clone().invert();this.binds.forEach(([o,n])=>{let s=o==i?e:n.position;o.updateMatrixWorld(!1),n.matrix.copy(o.matrixWorld).premultiply(a).decompose(s,n.quaternion,e)})}});AFRAME.registerComponent("vrm-mimic",{schema:{leftHandTarget:{type:"selector",default:""},leftHandOffsetPosition:{type:"vec3"},leftHandOffsetRotation:{type:"vec3",default:{x:0,y:-Math.PI/2,z:0}},rightHandTarget:{type:"selector",default:""},rightHandOffsetPosition:{type:"vec3"},rightHandOffsetRotation:{type:"vec3",default:{x:0,y:Math.PI/2,z:0}},leftLegTarget:{type:"selector",default:""},rightLegTarget:{type:"selector",default:""},headTarget:{type:"selector",default:""},avatarOffset:{type:"vec3",default:{x:0,y:0,z:0}}},init(){this._tmpV0=new THREE.Vector3,this._tmpV1=new THREE.Vector3,this._tmpQ0=new THREE.Quaternion,this._tmpQ1=new THREE.Quaternion,this._tmpM0=new THREE.Matrix4,this.targetEls=[],this.el.components.vrm&&this.el.components.vrm.avatar&&this._onAvatarUpdated(this.el.components.vrm.avatar),this.onVrmLoaded=i=>this._onAvatarUpdated(i.detail.avatar),this.el.addEventListener("model-loaded",this.onVrmLoaded)},update(){this.data.headTarget?this.data.headTarget.tagName=="A-CAMERA"?this.headTarget=this.el.sceneEl.camera:this.headTarget=this.data.headTarget.object3D:this.headTarget=null,this.rightHandOffset=new THREE.Matrix4().compose(this.data.rightHandOffsetPosition,new THREE.Quaternion().setFromEuler(new THREE.Euler().setFromVector3(this.data.rightHandOffsetRotation)),new THREE.Vector3(1,1,1)),this.leftHandOffset=new THREE.Matrix4().compose(this.data.leftHandOffsetPosition,new THREE.Quaternion().setFromEuler(new THREE.Euler().setFromVector3(this.data.leftHandOffsetRotation)),new THREE.Vector3(1,1,1))},_onAvatarUpdated(i){this.avatar=i;for(let e of this.targetEls)this.el.removeChild(e);this.targetEls=[],this.update(),this.startAvatarIK_simpleIK(i)},startAvatarIK_simpleIK(i){let e=new U;this.qbinds=[];let t=(a,o,n)=>{o==null&&(o=document.createElement("a-box"),o.classList.add("collidable"),o.setAttribute("xy-drag-control",{}),o.setAttribute("geometry",{width:.05,depth:.05,height:.05}),o.setAttribute("material",{color:"blue",depthTest:!1,transparent:!0,opacity:.4}),this.el.appendChild(o),this.targetEls.push(o));let s=(d,l)=>l.worldToLocal(d.getWorldPosition(new THREE.Vector3));a=a.filter(d=>i.bones[d]);let r=a.map(d=>i.bones[d]),h=r.map((d,l)=>{let m=l==0?d.position:s(d,r[l-1]),c=i.boneConstraints[a[l]],u=c?{apply:g=>this._applyConstraintQ(c,g.quaternion)}:null;return new F(m,u,d)});return this.qbinds.push([r[r.length-1],o.object3D,n]),{root:r[0],ikbones:h,bones:r,target:o.object3D}};this.chains=[t(["leftUpperArm","leftLowerArm","leftHand"],this.data.leftHandTarget,this.leftHandOffset),t(["rightUpperArm","rightLowerArm","rightHand"],this.data.rightHandTarget,this.rightHandOffset),t(["leftUpperLeg","leftLowerLeg","leftFoot"],this.data.leftLegTarget),t(["rightUpperLeg","rightLowerLeg","rightFoot"],this.data.rightLegTarget)],this.simpleIK=e},_applyConstraintQ(i,e){let t=this._tmpQ1,a=this._tmpV0,o=!1;if(i&&i.type=="ball"){let n=2*Math.acos(e.w);if(i.twistAxis){let s=n*Math.acos(e.w)*a.copy(e).normalize().dot(i.twistAxis);if(s=this._normalizeAngle(s),Math.abs(s)>i.twistLimit){let r=s<0?s+i.twistLimit:s-i.twistLimit;e.multiply(t.setFromAxisAngle(i.twistAxis,-r)),n=2*Math.acos(e.w),o=!0}}Math.abs(this._normalizeAngle(n))>i.limit&&(e.setFromAxisAngle(a.copy(e).normalize(),i.limit),o=!0)}else if(i&&i.type=="hinge"){let n=(i.min+i.max)/2,s=a.copy(e).normalize().dot(i.axis),r=2*Math.acos(e.w)*s;r=THREE.MathUtils.clamp(this._normalizeAngle(r-n),i.min-n,i.max-n),e.setFromAxisAngle(i.axis,r+n),o=!0}return o},_normalizeAngle(i){return i-Math.PI*2*Math.floor((i+Math.PI)/(Math.PI*2))},tick(i,e){if(!!this.avatar){if(this.headTarget){let t=this._tmpV0,a=this._tmpQ0;this.headTarget.matrixWorld.decompose(t,a,this._tmpV1),t.y=0,this.avatar.model.position.copy(t.add(this.data.avatarOffset));let o=this.avatar.firstPersonBone;if(o){let n=this._tmpQ1.setFromRotationMatrix(o.parent.matrixWorld).invert();o.quaternion.copy(a.premultiply(n))}}if(this.simpleIK){let t=this.el.object3D.matrixWorld.clone().invert();for(let a of this.chains){let o=a.root.parent.matrixWorld.clone().premultiply(t);this.simpleIK.solve(a.ikbones,a.target.position,o),a.ikbones.forEach((n,s)=>{if(s==a.ikbones.length-1)return;let r=n.userData.quaternion.angleTo(n.quaternion);r>.2?n.userData.quaternion.slerp(n.quaternion,.2/r):n.userData.quaternion.copy(n.quaternion)})}this.qbinds.forEach(([a,o,n])=>{let s=n?o.matrixWorld.clone().multiply(n):o.matrixWorld,r=this._tmpQ0.setFromRotationMatrix(a.parent.matrixWorld).invert();a.quaternion.copy(this._tmpQ1.setFromRotationMatrix(s).premultiply(r))})}}},remove(){this.el.removeEventListener("model-loaded",this.onVrmLoaded);for(let i of this.targetEls)this.el.removeChild(i)}});})();
//# sourceMappingURL=aframe-vrm.min.js.map
